select
PRN AS 'MRN', 
PNAME AS 'NAME', 
REG.RDATETIME AS 'FIRST VISIT DT',  
REG.RPRIMARYDOCNAME AS 'FIRST PRACTIONER', 
PLASTVISITDATE AS 'LAST VISIT DT', 
LATESTREG.RPRIMARYDOCNAME AS 'LAST VISIT PRACTITIONER', 
NXAPPT.APSTART AS 'NEXT APPT DT', 
NXAPPT.UFULLNAME AS 'NEXT APPT PRACTITIONER', 
CT.COUNT AS 'VISIT COUNT', 
COMPREFERRALTYPE.CPTDESC AS '1ST RERF TYPE', 
COMPREFERRALSUBTYPE.CPSTDESC AS '1ST REF SUBTYPE', 
COMPREFERRAL.NAME AS '1ST REF BY', 
UXINFO.UFULLNAME AS '1ST VISIT REGISTERED BY', 
DIAG.DIAGNOSISNAME AS '1ST VISIT PRIMARY DIAGNOSIS', 
DIAG.DIAGNOSISDETAIL AS '1ST VISIT PRIMARY DIAGNOSIS REMARKS', 
PDOB AS 'DOB', 
PGENDER AS 'GENDER', 
PMPHONE AS 'PHONE NO.', 
PADDR1 AS 'ADDRESS 1', 
PADDR2 AS 'ADDRESS 2', 
PADDR3 AS 'ADDRESS 3', 
PCITY AS 'CITY', 
PPOSTCODE AS 'POSTCODE', 
PSTATEDESC AS'STATE', 
PCOUNTRYDESC AS 'COUNTRY'
from patient WITH (NOLOCK)
OUTER APPLY (
	SELECT TOP 1 * FROM registration WITH (NOLOCK)
	WHERE registration.RRN = patient.PRN
	ORDER BY RDATETIME) AS REG
OUTER APPLY (
	SELECT TOP 1 * FROM PatientDiagnosis WITH (NOLOCK)
	WHERE PatientDiagnosis.MRN = patient.PRN
	AND DIAGNOSISTYPE = 'PRIMARY'
	ORDER BY INSERTDT) AS DIAG
OUTER APPLY (
	SELECT RRN [COUNTRRN], COUNT(RVN) [COUNT]
	FROM registration with (NOLOCK)
	WHERE registration.RRN = patient.PRN
	GROUP BY RRN) AS CT
OUTER APPLY (
	SELECT TOP 1 * FROM appointments WITH (NOLOCK)
	LEFT JOIN UXINFO ON appointments.APDOCID = UXINFO.UNITID
	WHERE appointments.APPRN = patient.PRN
	AND APSTART >= GETDATE() AND APSTATUS != '2' AND APSTATUS != '3' AND APSTATUS != '5'
	ORDER BY APSTART) AS NXAPPT
OUTER APPLY (
	SELECT TOP 1 * FROM registration WITH (NOLOCK)
	WHERE registration.RRN = patient.PRN
	ORDER BY RDATETIME DESC) AS LATESTREG
LEFT JOIN COMPREFERRAL WITH (NOLOCK) ON REG.RREFSOURCECODE = COMPREFERRAL.CODE
LEFT JOIN COMPREFERRALSUBTYPE WITH (NOLOCK) ON COMPREFERRAL.CPSTID = COMPREFERRALSUBTYPE.CPSTID
LEFT JOIN COMPREFERRALTYPE WITH (NOLOCK) ON COMPREFERRALSUBTYPE.CPTID = COMPREFERRALTYPE.CPTID
LEFT JOIN UXINFO WITH (NOLOCK) ON REG.RUID = UXINFO.UNITID
WHERE PNAME NOT LIKE '%BEACON%'
AND REG.RDATETIME >= '2023-02-01 00:00:00' AND REG.RDATETIME <= '2023-02-28 23:59:59'
